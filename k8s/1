---
# This playbook deploys the Kubernetes cluster with Contrail CNI

# Author: SAVITHRU LOKANATH
# Contact: SAVITHRU AT ICLOUD DOT COM

- name: Reset kubernetes if installed
  shell: kubeadm reset
  register: reset
  tags: master

- name: Generate kubeadm token
  when: reset | succeeded
  shell: kubeadm token generate
  register: kubeadm_token
  tags: master

- name: Get token
  set_fact: token={{ kubeadm_token.stdout }}

- name: Initialize kubernetes master
  shell: kubeadm init --token {{ token }}
  register: init
  failed_when: "'FAILED' in init.stderr"
  tags: master

- name: Create kubernetes conf local directory
  file: 
    path: "{{ lookup('env', 'HOME')}}/.kube"
    state: directory
  tags: master

- name: Copy kube-config to local path
  copy:
    src: /etc/kubernetes/admin.conf
    dest: "{{ lookup('env', 'HOME')}}/.kube/config"
    owner: root
    group: root
    mode: 0755
    remote_src: True
  tags: master
